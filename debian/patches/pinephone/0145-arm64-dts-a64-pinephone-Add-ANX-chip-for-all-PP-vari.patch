From: Ondrej Jirman <megous@megous.com>
Date: Tue, 9 Jun 2020 21:11:09 -0500
Subject: [PATCH 142/194] arm64: dts: a64: pinephone: Add ANX chip for all PP
 variants 1.0-1.2

Signed-off-by: Ondrej Jirman <megous@megous.com>
[Samuel: Factored out common properties]
Signed-off-by: Samuel Holland <samuel@sholland.org>
---
 .../dts/allwinner/sun50i-a64-pinephone-1.0.dts     | 10 +++++
 .../dts/allwinner/sun50i-a64-pinephone-1.1.dts     | 10 +++++
 .../dts/allwinner/sun50i-a64-pinephone-1.2.dts     |  9 +++++
 .../boot/dts/allwinner/sun50i-a64-pinephone.dtsi   | 44 +++++++++++++++++++++-
 4 files changed, 72 insertions(+), 1 deletion(-)

diff --git a/arch/arm64/boot/dts/allwinner/sun50i-a64-pinephone-1.0.dts b/arch/arm64/boot/dts/allwinner/sun50i-a64-pinephone-1.0.dts
index 1d2d72d..56e141f 100644
--- a/arch/arm64/boot/dts/allwinner/sun50i-a64-pinephone-1.0.dts
+++ b/arch/arm64/boot/dts/allwinner/sun50i-a64-pinephone-1.0.dts
@@ -10,6 +10,11 @@ / {
 	compatible = "pine64,pinephone-1.0", "pine64,pinephone", "allwinner,sun50i-a64";
 };
 
+&anx7688 {
+	reset-gpios = <&r_pio 0 9 GPIO_ACTIVE_HIGH>; /* PL9 */
+	avdd33-supply = <&reg_dldo1>;
+};
+
 &axp803 {
 	x-powers,drive-vbus-en;
 };
@@ -18,6 +23,11 @@ &codec_analog {
 	allwinner,internal-bias-resistor;
 };
 
+/*
+ * The N_VBUSEN pin is disconnected, but we need to inform the PMIC about
+ * the VBUS status anyway. To avoid the pin from floating and to inform
+ * the PMIC, about VBUS status, we couple reg_drivevbus with reg_vbus.
+ */
 &reg_drivevbus {
 	vin-supply = <&reg_usb_5v>;
 	status = "okay";
diff --git a/arch/arm64/boot/dts/allwinner/sun50i-a64-pinephone-1.1.dts b/arch/arm64/boot/dts/allwinner/sun50i-a64-pinephone-1.1.dts
index 223a7ed..de41482 100644
--- a/arch/arm64/boot/dts/allwinner/sun50i-a64-pinephone-1.1.dts
+++ b/arch/arm64/boot/dts/allwinner/sun50i-a64-pinephone-1.1.dts
@@ -10,6 +10,11 @@ / {
 	compatible = "pine64,pinephone-1.1", "pine64,pinephone", "allwinner,sun50i-a64";
 };
 
+&anx7688 {
+	reset-gpios = <&r_pio 0 9 GPIO_ACTIVE_HIGH>; /* PL9 */
+	avdd33-supply = <&reg_dldo1>;
+};
+
 &axp803 {
 	x-powers,drive-vbus-en;
 };
@@ -37,6 +42,11 @@ &codec_analog {
 	allwinner,internal-bias-resistor;
 };
 
+/*
+ * The N_VBUSEN pin is disconnected, but we need to inform the PMIC about
+ * the VBUS status anyway. To avoid the pin from floating and to inform
+ * the PMIC, about VBUS status, we couple reg_drivevbus with reg_vbus.
+ */
 &reg_drivevbus {
 	vin-supply = <&reg_usb_5v>;
 	status = "okay";
diff --git a/arch/arm64/boot/dts/allwinner/sun50i-a64-pinephone-1.2.dts b/arch/arm64/boot/dts/allwinner/sun50i-a64-pinephone-1.2.dts
index b08ddd0..c3bd7bc 100644
--- a/arch/arm64/boot/dts/allwinner/sun50i-a64-pinephone-1.2.dts
+++ b/arch/arm64/boot/dts/allwinner/sun50i-a64-pinephone-1.2.dts
@@ -15,6 +15,11 @@ wifi_pwrseq: wifi-pwrseq {
 	};
 };
 
+&anx7688 {
+	reset-gpios = <&pio 3 6 GPIO_ACTIVE_HIGH>; /* PD6 */
+	avdd33-supply = <&reg_dcdc1>;
+};
+
 &axp803 {
 	x-powers,sense-vbus-en;
 };
@@ -62,6 +67,10 @@ &reg_anx1v0 {
 };
 
 &reg_vbus {
+	/*
+	 * ANX7688 will enable/disable USB-5V <-> DCIN switch by itself
+	 * via VBUS_CTRL pin, so no GPIO is needed here.
+	 */
 	vin-supply = <&reg_usb_5v>;
 };
 
diff --git a/arch/arm64/boot/dts/allwinner/sun50i-a64-pinephone.dtsi b/arch/arm64/boot/dts/allwinner/sun50i-a64-pinephone.dtsi
index 7aea271..d154fd0 100644
--- a/arch/arm64/boot/dts/allwinner/sun50i-a64-pinephone.dtsi
+++ b/arch/arm64/boot/dts/allwinner/sun50i-a64-pinephone.dtsi
@@ -314,6 +314,41 @@ ov5640_ep: endpoint {
 &i2c0 {
 	status = "okay";
 
+	anx7688: hdmi-bridge@28 {
+		compatible = "analogix,anx7688";
+		reg = <0x28>;
+
+		interrupt-parent = <&r_pio>;
+		interrupts = <0 11 IRQ_TYPE_EDGE_FALLING>; /* PL11 */
+
+		enable-gpios = <&pio 3 10 GPIO_ACTIVE_LOW>; /* PD10 */
+		cabledet-gpios = <&r_pio 0 8 GPIO_ACTIVE_HIGH>; /* PL8 */
+
+		avdd10-supply = <&reg_anx1v0>;
+		dvdd10-supply = <&reg_anx1v0>;
+		avdd18-supply = <&reg_ldo_io1>;
+		dvdd18-supply = <&reg_ldo_io1>;
+		vconn-supply = <&reg_vconn5v0>;
+		hdmi_vt-supply = <&reg_dldo1>;
+
+		source-caps = <
+			PDO_FIXED(5000, 500, PDO_FIXED_DATA_SWAP | PDO_FIXED_USB_COMM | PDO_FIXED_DUAL_ROLE)
+		>;
+
+		sink-caps = <
+			PDO_FIXED(5000, 3000, PDO_FIXED_DATA_SWAP | PDO_FIXED_USB_COMM | PDO_FIXED_DUAL_ROLE)
+		>;
+
+		vbus-supply = <&reg_vbus>;
+		vbus_in-supply = <&usb_power_supply>;
+
+		port {
+			typec0_dr_sw: endpoint {
+				remote-endpoint = <&usb0_drd_sw>;
+			};
+		};
+	};
+
 	touchscreen@5d {
 		compatible = "goodix,gt917s";
 		reg = <0x5d>;
@@ -681,7 +716,7 @@ &uart3 {
 };
 
 &usb_otg {
-	dr_mode = "peripheral";
+	dr_mode = "otg";
 	status = "okay";
 };
 
@@ -691,4 +726,11 @@ &usb_power_supply {
 
 &usbphy {
 	status = "okay";
+	usb-role-switch;
+
+	port {
+		usb0_drd_sw: endpoint {
+			remote-endpoint = <&typec0_dr_sw>;
+		};
+	};
 };
